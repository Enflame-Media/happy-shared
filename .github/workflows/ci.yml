# CI Workflow for happy-shared repository
# Comprehensive PR validation: type checking, linting, tests, and build verification
# Part of HAP-22 implementation

name: CI

permissions:
  contents: read

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Build shared dependencies first
  # ============================================
  build-protocol:
    name: Build @happy/protocol
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Enable Corepack (for Yarn 4)
        run: corepack enable

      - name: Get yarn cache directory
        id: yarn-cache-dir
        run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

      - name: Cache yarn dependencies
        uses: actions/cache@v5
        with:
          path: |
            ${{ steps.yarn-cache-dir.outputs.dir }}
            .yarn/install-state.gz
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build @happy/protocol
        run: yarn workspace @happy/protocol build

      - name: Type check @happy/protocol
        run: yarn workspace @happy/protocol typecheck

      # Upload built protocol for dependent jobs
      - name: Upload protocol dist
        uses: actions/upload-artifact@v6
        with:
          name: protocol-dist
          path: packages/@happy/protocol/dist
          retention-days: 1

  # ============================================
  # Type Check - All Projects (parallel)
  # ============================================
  typecheck-cli:
    name: Type Check - happy-cli
    runs-on: ubuntu-latest
    needs: build-protocol
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Enable Corepack
        run: corepack enable

      - name: Cache yarn dependencies
        uses: actions/cache@v5
        with:
          path: |
            .yarn/cache
            .yarn/install-state.gz
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Download protocol dist
        uses: actions/download-artifact@v7
        with:
          name: protocol-dist
          path: packages/@happy/protocol/dist

      - name: Install dependencies
        run: yarn install --immutable

      - name: Type check happy-cli
        working-directory: happy-cli
        run: yarn typecheck

  typecheck-workers:
    name: Type Check - happy-server-workers
    runs-on: ubuntu-latest
    needs: build-protocol
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Enable Corepack
        run: corepack enable

      - name: Cache yarn dependencies
        uses: actions/cache@v5
        with:
          path: |
            .yarn/cache
            .yarn/install-state.gz
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Download protocol dist
        uses: actions/download-artifact@v7
        with:
          name: protocol-dist
          path: packages/@happy/protocol/dist

      - name: Install dependencies
        run: yarn install --immutable

      - name: Type check happy-server-workers
        working-directory: happy-server-workers
        run: yarn typecheck

  typecheck-app:
    name: Type Check - happy-app
    runs-on: ubuntu-latest
    needs: build-protocol
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Enable Corepack
        run: corepack enable

      - name: Cache yarn dependencies
        uses: actions/cache@v5
        with:
          path: |
            .yarn/cache
            .yarn/install-state.gz
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Download protocol dist
        uses: actions/download-artifact@v7
        with:
          name: protocol-dist
          path: packages/@happy/protocol/dist

      - name: Install dependencies
        run: yarn install --immutable

      - name: Type check happy-app
        working-directory: happy-app
        run: yarn typecheck

  # ============================================
  # Lint - All Projects (parallel)
  # ============================================
  lint-cli:
    name: Lint - happy-cli
    runs-on: ubuntu-latest
    needs: build-protocol
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Enable Corepack
        run: corepack enable

      - name: Cache yarn dependencies
        uses: actions/cache@v5
        with:
          path: |
            .yarn/cache
            .yarn/install-state.gz
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Download protocol dist
        uses: actions/download-artifact@v7
        with:
          name: protocol-dist
          path: packages/@happy/protocol/dist

      - name: Install dependencies
        run: yarn install --immutable

      - name: Lint happy-cli
        working-directory: happy-cli
        run: yarn lint

  lint-workers:
    name: Lint - happy-server-workers
    runs-on: ubuntu-latest
    needs: build-protocol
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Enable Corepack
        run: corepack enable

      - name: Cache yarn dependencies
        uses: actions/cache@v5
        with:
          path: |
            .yarn/cache
            .yarn/install-state.gz
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Download protocol dist
        uses: actions/download-artifact@v7
        with:
          name: protocol-dist
          path: packages/@happy/protocol/dist

      - name: Install dependencies
        run: yarn install --immutable

      - name: Lint happy-server-workers
        working-directory: happy-server-workers
        run: yarn lint

  lint-app:
    name: Lint - happy-app
    runs-on: ubuntu-latest
    needs: build-protocol
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Enable Corepack
        run: corepack enable

      - name: Cache yarn dependencies
        uses: actions/cache@v5
        with:
          path: |
            .yarn/cache
            .yarn/install-state.gz
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Download protocol dist
        uses: actions/download-artifact@v7
        with:
          name: protocol-dist
          path: packages/@happy/protocol/dist

      - name: Install dependencies
        run: yarn install --immutable

      - name: Lint happy-app
        working-directory: happy-app
        run: yarn lint

  lint-admin:
    name: Lint - happy-admin
    runs-on: ubuntu-latest
    needs: build-protocol
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Enable Corepack
        run: corepack enable

      - name: Cache yarn dependencies
        uses: actions/cache@v5
        with:
          path: |
            .yarn/cache
            .yarn/install-state.gz
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Download protocol dist
        uses: actions/download-artifact@v7
        with:
          name: protocol-dist
          path: packages/@happy/protocol/dist

      - name: Install dependencies
        run: yarn install --immutable

      - name: Lint happy-admin
        working-directory: happy-admin
        run: yarn lint

  lint-admin-api:
    name: Lint - happy-admin-api
    runs-on: ubuntu-latest
    needs: build-protocol
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Enable Corepack
        run: corepack enable

      - name: Cache yarn dependencies
        uses: actions/cache@v5
        with:
          path: |
            .yarn/cache
            .yarn/install-state.gz
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Download protocol dist
        uses: actions/download-artifact@v7
        with:
          name: protocol-dist
          path: packages/@happy/protocol/dist

      - name: Install dependencies
        run: yarn install --immutable

      - name: Lint happy-admin-api
        working-directory: happy-admin-api
        run: yarn lint

  # ============================================
  # Tests - All Projects (parallel)
  # ============================================
  test-workers:
    name: Test - happy-server-workers
    runs-on: ubuntu-latest
    needs: build-protocol
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Enable Corepack
        run: corepack enable

      - name: Cache yarn dependencies
        uses: actions/cache@v5
        with:
          path: |
            .yarn/cache
            .yarn/install-state.gz
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Download protocol dist
        uses: actions/download-artifact@v7
        with:
          name: protocol-dist
          path: packages/@happy/protocol/dist

      - name: Install dependencies
        run: yarn install --immutable

      - name: Run tests
        working-directory: happy-server-workers
        run: yarn test

  # ============================================
  # Build Verification - Workers
  # ============================================
  build-workers:
    name: Build - happy-server-workers
    runs-on: ubuntu-latest
    needs: [typecheck-workers, lint-workers, test-workers]
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Enable Corepack
        run: corepack enable

      - name: Cache yarn dependencies
        uses: actions/cache@v5
        with:
          path: |
            .yarn/cache
            .yarn/install-state.gz
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Download protocol dist
        uses: actions/download-artifact@v7
        with:
          name: protocol-dist
          path: packages/@happy/protocol/dist

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build Workers (dry-run)
        working-directory: happy-server-workers
        run: npx wrangler deploy --dry-run --outdir=dist
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  # ============================================
  # Build - happy-cli
  # ============================================
  build-cli:
    name: Build - happy-cli
    runs-on: ubuntu-latest
    needs: [typecheck-cli, lint-cli]
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Enable Corepack
        run: corepack enable

      - name: Cache yarn dependencies
        uses: actions/cache@v5
        with:
          path: |
            .yarn/cache
            .yarn/install-state.gz
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Download protocol dist
        uses: actions/download-artifact@v7
        with:
          name: protocol-dist
          path: packages/@happy/protocol/dist

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build happy-cli
        working-directory: happy-cli
        run: yarn build

  # ============================================
  # OpenAPI Validation - happy-server
  # ============================================
  openapi-server:
    name: OpenAPI - happy-server
    runs-on: ubuntu-latest
    needs: build-protocol
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Enable Corepack
        run: corepack enable

      - name: Cache yarn dependencies
        uses: actions/cache@v5
        with:
          path: |
            .yarn/cache
            .yarn/install-state.gz
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Download protocol dist
        uses: actions/download-artifact@v7
        with:
          name: protocol-dist
          path: packages/@happy/protocol/dist

      - name: Install dependencies
        run: yarn install --immutable

      - name: Generate OpenAPI spec
        working-directory: happy-server
        run: yarn openapi:generate

      - name: Validate OpenAPI spec
        working-directory: happy-server
        run: npx @redocly/cli lint openapi.json --skip-rule no-server-example.com

      - name: Upload OpenAPI spec artifact
        uses: actions/upload-artifact@v6
        with:
          name: openapi-spec
          path: happy-server/openapi.json
          retention-days: 7

  # ============================================
  # Schema Drift Detection
  # ============================================
  schema-drift:
    name: Schema Drift Detection
    runs-on: ubuntu-latest
    needs: [build-protocol, openapi-server]
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Enable Corepack
        run: corepack enable

      - name: Cache yarn dependencies
        uses: actions/cache@v5
        with:
          path: |
            .yarn/cache
            .yarn/install-state.gz
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Download protocol dist
        uses: actions/download-artifact@v7
        with:
          name: protocol-dist
          path: packages/@happy/protocol/dist

      - name: Download OpenAPI spec
        uses: actions/download-artifact@v7
        with:
          name: openapi-spec
          path: happy-server

      - name: Install dependencies
        run: yarn install --immutable

      - name: Extract protocol schemas
        run: yarn schema:extract

      - name: Upload protocol schemas artifact
        uses: actions/upload-artifact@v6
        with:
          name: protocol-schemas
          path: packages/@happy/protocol/protocol-schemas.json
          retention-days: 7

      - name: Compare schemas
        run: yarn schema:compare --ci

      - name: Upload drift report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: schema-drift-report
          path: schema-diff.md
          retention-days: 7

      - name: Add report to step summary
        if: always()
        run: |
          if [ -f schema-diff.md ]; then
            cat schema-diff.md >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # CI Summary
  # ============================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [build-protocol, typecheck-cli, typecheck-workers, typecheck-app, lint-cli, lint-workers, lint-app, lint-admin, lint-admin-api, test-workers, build-workers, build-cli, openapi-server, schema-drift]
    if: always()

    steps:
      - name: Check job results
        env:
          PROTOCOL_RESULT: ${{ needs.build-protocol.result }}
          CLI_TC_RESULT: ${{ needs.typecheck-cli.result }}
          WORKERS_TC_RESULT: ${{ needs.typecheck-workers.result }}
          APP_TC_RESULT: ${{ needs.typecheck-app.result }}
          CLI_LINT_RESULT: ${{ needs.lint-cli.result }}
          WORKERS_LINT_RESULT: ${{ needs.lint-workers.result }}
          APP_LINT_RESULT: ${{ needs.lint-app.result }}
          ADMIN_LINT_RESULT: ${{ needs.lint-admin.result }}
          ADMIN_API_LINT_RESULT: ${{ needs.lint-admin-api.result }}
          WORKERS_TEST_RESULT: ${{ needs.test-workers.result }}
          WORKERS_BUILD_RESULT: ${{ needs.build-workers.result }}
          CLI_BUILD_RESULT: ${{ needs.build-cli.result }}
          OPENAPI_SERVER_RESULT: ${{ needs.openapi-server.result }}
          SCHEMA_DRIFT_RESULT: ${{ needs.schema-drift.result }}
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          # Function to get status emoji
          get_status() {
            if [ "$1" = "success" ]; then
              echo "✅ Passed"
            else
              echo "❌ Failed"
            fi
          }

          echo "| Build @happy/protocol | $(get_status "$PROTOCOL_RESULT") |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check - happy-cli | $(get_status "$CLI_TC_RESULT") |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check - happy-server-workers | $(get_status "$WORKERS_TC_RESULT") |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check - happy-app | $(get_status "$APP_TC_RESULT") |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint - happy-cli | $(get_status "$CLI_LINT_RESULT") |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint - happy-server-workers | $(get_status "$WORKERS_LINT_RESULT") |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint - happy-app | $(get_status "$APP_LINT_RESULT") |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint - happy-admin | $(get_status "$ADMIN_LINT_RESULT") |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint - happy-admin-api | $(get_status "$ADMIN_API_LINT_RESULT") |" >> $GITHUB_STEP_SUMMARY
          echo "| Test - happy-server-workers | $(get_status "$WORKERS_TEST_RESULT") |" >> $GITHUB_STEP_SUMMARY
          echo "| Build - happy-server-workers | $(get_status "$WORKERS_BUILD_RESULT") |" >> $GITHUB_STEP_SUMMARY
          echo "| Build - happy-cli | $(get_status "$CLI_BUILD_RESULT") |" >> $GITHUB_STEP_SUMMARY
          echo "| OpenAPI - happy-server | $(get_status "$OPENAPI_SERVER_RESULT") |" >> $GITHUB_STEP_SUMMARY
          echo "| Schema Drift Detection | $(get_status "$SCHEMA_DRIFT_RESULT") |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any job failed
        env:
          PROTOCOL_RESULT: ${{ needs.build-protocol.result }}
          CLI_TC_RESULT: ${{ needs.typecheck-cli.result }}
          WORKERS_TC_RESULT: ${{ needs.typecheck-workers.result }}
          APP_TC_RESULT: ${{ needs.typecheck-app.result }}
          CLI_LINT_RESULT: ${{ needs.lint-cli.result }}
          WORKERS_LINT_RESULT: ${{ needs.lint-workers.result }}
          APP_LINT_RESULT: ${{ needs.lint-app.result }}
          ADMIN_LINT_RESULT: ${{ needs.lint-admin.result }}
          ADMIN_API_LINT_RESULT: ${{ needs.lint-admin-api.result }}
          WORKERS_TEST_RESULT: ${{ needs.test-workers.result }}
          WORKERS_BUILD_RESULT: ${{ needs.build-workers.result }}
          CLI_BUILD_RESULT: ${{ needs.build-cli.result }}
          OPENAPI_SERVER_RESULT: ${{ needs.openapi-server.result }}
          SCHEMA_DRIFT_RESULT: ${{ needs.schema-drift.result }}
        run: |
          if [ "$PROTOCOL_RESULT" != "success" ] || \
             [ "$CLI_TC_RESULT" != "success" ] || \
             [ "$WORKERS_TC_RESULT" != "success" ] || \
             [ "$APP_TC_RESULT" != "success" ] || \
             [ "$CLI_LINT_RESULT" != "success" ] || \
             [ "$WORKERS_LINT_RESULT" != "success" ] || \
             [ "$APP_LINT_RESULT" != "success" ] || \
             [ "$ADMIN_LINT_RESULT" != "success" ] || \
             [ "$ADMIN_API_LINT_RESULT" != "success" ] || \
             [ "$WORKERS_TEST_RESULT" != "success" ] || \
             [ "$WORKERS_BUILD_RESULT" != "success" ] || \
             [ "$CLI_BUILD_RESULT" != "success" ] || \
             [ "$OPENAPI_SERVER_RESULT" != "success" ] || \
             [ "$SCHEMA_DRIFT_RESULT" != "success" ]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All jobs passed!"
